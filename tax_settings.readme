Historical year view
themes/default/admin/views/tax_calculations/historical_year.php
Year dropdown (current year down to 15 years back), with “(already has data)” when the year exists.
Tax: total_sales, taxable_income, tax_due, advance_payments_made, balance_payment, next_year_advance_base, previous_year_inps, coefficient_used, tax_rate_used.
Tax payments table: balance, first advance, second advance (amount, paid_amount, paid_date, status).
INPS: inps_taxable_income, inps_amount, discount_percentage, discount_amount, inps_amount_after_discount; 3 or 4 installments (3 for Gestione Separata, 4 for Commercianti/Artigiani) with amount, paid_amount, paid_date, status (PENDING/PAID/OVERDUE).
INAIL: only if $is_artigiani (inail_taxable_income, inail_final_amount, one payment: amount, paid_amount, paid_date, status).
Diritto annuale: only if $is_commercianti_artigiani (amount, paid_amount, paid_date, status).
Fattura tra privati (optional): total_invoices, total_sales_amount, total_payment_amount, paid_amount, paid_date, status.
Form posts to tax_calculations/save_historical_year with hidden customer_id; buttons: Back to settings, Save historical year, View tax calculation.


All customer types are supported: Gestione Separata (3 INPS installments), Commercianti/Artigiani (4 INPS + diritto annuale), Artigiani (INAIL block).
Settings check: the controller still redirects to settings with historical_year_settings_required if the customer has no valid tax settings (customer type, coefficient, tax rate) before allowing the historical year form.